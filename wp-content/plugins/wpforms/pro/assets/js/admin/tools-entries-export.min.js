"use strict";var WPFormsEntriesExport=window.WPFormsEntriesExport||function(e,t,o){var i={$form:o("#wpforms-tools-entries-export"),$selectForm:o("#wpforms-tools-entries-export-selectform"),$selectFormSpinner:o("#wpforms-tools-entries-export-selectform-spinner"),$selectFormMsg:o("#wpforms-tools-entries-export-selectform-msg"),$expOptions:o("#wpforms-tools-entries-export-options"),$fieldsCheckboxes:o("#wpforms-tools-entries-export-options-fields-checkboxes"),$dateSection:o("#wpforms-tools-entries-export-options-date"),$dateFlatpickr:o("#wpforms-tools-entries-export-options-date-flatpickr"),$searchSection:o("#wpforms-tools-entries-export-options-search"),$searchField:o("#wpforms-tools-entries-export-options-search-field"),$submitButton:o("#wpforms-tools-entries-export-submit"),$cancelButton:o("#wpforms-tools-entries-export-cancel"),$processMsg:o("#wpforms-tools-entries-export-process-msg")},a=wpforms_tools_entries_export.i18n,r={},n={formsCache:{},init:function(){o(n.ready)},ready:function(){r.processing=!1,n.initDateRange(),n.initFormCont(),n.initSubmit(),n.events()},events:function(){i.$selectForm[0].addEventListener("choice",function(e){e.detail.choice.placeholder?i.$expOptions.addClass("hidden"):r.formID!==e.detail.choice.value&&(r.formID=e.detail.choice.value,void 0===n.formsCache[r.formID]?n.retrieveFormAndRenderFields():n.renderFields(n.formsCache[r.formID]))}),o(e).on("csv_file_error",function(e,o){n.displaySubmitMsg(o,"error")})},retrieveFormAndRenderFields:function(){r.ajaxData={action:"wpforms_tools_entries_export_form_data",nonce:wpforms_tools_entries_export.nonce,form:r.formID},i.$selectFormSpinner.removeClass("hidden"),n.displayFormsMsg(""),o.get(ajaxurl,r.ajaxData).done(function(e){e.success?(n.renderFields(e.data.fields),n.formsCache[r.formID]=e.data.fields,i.$expOptions.removeClass("hidden")):(n.displayFormsMsg(e.data.error),i.$expOptions.addClass("hidden"))}).fail(function(e,o,s){n.displayFormsMsg(a.error_prefix+":<br>"+s),i.$expOptions.addClass("hidden")}).always(function(){i.$selectFormSpinner.addClass("hidden")})},exportAjaxStep:function(e){r.processing&&(e=n.getAjaxPostData(e),o.post(ajaxurl,e).done(function(e){var o;clearTimeout(r.timerId),e.success?0!==e.data.count?(o=a.prc_3_done,o+="<br>"+a.prc_3_download+', <a href="#" class="wpforms-download-link">'+a.prc_3_click_here+"</a>.",n.displaySubmitMsg(o,"info"),n.triggerDownload(e.data.request_id)):n.displaySubmitMsg(a.prc_2_no_entries):n.displaySubmitMsg(e.data.error,"error")}).fail(function(e,o,s){clearTimeout(r.timerId),n.displaySubmitMsg(a.error_prefix+":<br>"+s,"error")}).always(function(){n.displaySubmitSpinner(!1)}))},getAjaxPostData:function(e){var o;return"first-step"===e?(o=i.$form.serializeArray().reduce(function(e,o){return e[o.name]=o.value,e},{}),i.$fieldsCheckboxes.find("input").length<1&&(o.date="",o["search[term]"]="")):o={action:"wpforms_tools_entries_export_step",nonce:wpforms_tools_entries_export.nonce,request_id:e},o},initSubmit:function(){i.$submitButton.on("click",function(e){e.preventDefault(),o(this).hasClass("wpforms-btn-spinner-on")||(i.$submitButton.blur(),n.displaySubmitSpinner(!0),n.displaySubmitMsg(""),r.timerId=setTimeout(function(){n.displaySubmitMsg(a.prc_1_filtering+"<br>"+a.prc_1_please_wait,"info")},3e3),n.exportAjaxStep("first-step"))}),i.$cancelButton.on("click",function(e){e.preventDefault(),i.$cancelButton.blur(),n.displaySubmitMsg(""),n.displaySubmitSpinner(!1)})},initFormCont:function(){0<wpforms_tools_entries_export.form_id&&(i.$expOptions.removeClass("hidden"),i.$fieldsCheckboxes.find("input").length<1&&(i.$dateSection.addClass("hidden"),i.$searchSection.addClass("hidden")))},initDateRange:function(){var e=wpforms_tools_entries_export.lang_code,o=t.flatpickr,s={rangeSeparator:" - "};"undefined"!==o&&o.hasOwnProperty("l10ns")&&o.l10ns.hasOwnProperty(e)&&((s=o.l10ns[e]).rangeSeparator=" - "),i.$dateFlatpickr.flatpickr({altInput:!0,altFormat:"M j, Y",dateFormat:"Y-m-d",locale:s,mode:"range",defaultDate:wpforms_tools_entries_export.dates})},renderFields:function(r){var n,e;"object"==typeof r&&(n={checkboxes:"",options:""},0===(e=Object.keys(r)).length?(n.checkboxes="<span>"+a.error_form_empty+"</span>",i.$dateSection.addClass("hidden"),i.$searchSection.addClass("hidden")):(e.forEach(function(e,o){var s='<label><input type="checkbox" name="fields[{i}]" value="{id}" checked> {label}</label>',t=parseInt(r[e].id,10),o=(s=(s=(s=s.replace("{i}",parseInt(o,10))).replace("{id}",t)).replace("{label}",r[e].label),n.checkboxes+=s,'<option value="{id}">{label}</option>');o=(o=o.replace("{id}",t)).replace("{label}",r[e].label),n.options+=o}),i.$dateSection.removeClass("hidden"),i.$searchSection.removeClass("hidden")),i.$fieldsCheckboxes.html(n.checkboxes),i.$searchField.find("optgroup:first-child option:not(:first-child)").remove(),i.$searchField.find("optgroup:first-child").append(n.options))},displaySubmitSpinner:function(e){e?(i.$submitButton.addClass("wpforms-btn-spinner-on"),i.$cancelButton.removeClass("hidden"),r.processing=!0):(i.$submitButton.removeClass("wpforms-btn-spinner-on"),i.$cancelButton.addClass("hidden"),r.processing=!1)},displayFormsMsg:function(e){i.$selectFormMsg.html(e),0<e.length?i.$selectFormMsg.removeClass("hidden"):i.$selectFormMsg.addClass("hidden")},displaySubmitMsg:function(e,o){o&&"error"===o?i.$processMsg.addClass("wpforms-error"):i.$processMsg.removeClass("wpforms-error"),i.$processMsg.html(e),0<e.length?i.$processMsg.removeClass("hidden"):i.$processMsg.addClass("hidden")},triggerDownload:function(e){var o=wpforms_tools_entries_export.export_page,o=(o+="&action=wpforms_tools_entries_export_download")+("&nonce="+wpforms_tools_entries_export.nonce)+("&request_id="+e);i.$expOptions.find("iframe").remove(),i.$expOptions.append('<iframe src="'+o+'"></iframe>'),i.$processMsg.find(".wpforms-download-link").attr("href",o)}};return n}(document,window,jQuery);WPFormsEntriesExport.init();