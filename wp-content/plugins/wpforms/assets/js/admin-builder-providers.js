(function($){var s;var WPFormsProviders={settings:{spinner:'<i class="wpforms-loading-spinner wpforms-loading-inline"></i>',spinnerWhite:'<i class="wpforms-loading-spinner wpforms-loading-inline wpforms-loading-white"></i>',},init:function(){s=this.settings;$(WPFormsProviders.ready);WPFormsProviders.bindUIActions();},ready:function(){s.form=$('#wpforms-builder-form');},bindUIActions:function(){$(document).on('click','.wpforms-provider-connection-delete',function(e){WPFormsProviders.connectionDelete(this,e);});$(document).on('click','.wpforms-provider-connections-add',function(e){WPFormsProviders.connectionAdd(this,e);});$(document).on('click','.wpforms-provider-account-add button',function(e){WPFormsProviders.accountAdd(this,e);});$(document).on('change','.wpforms-provider-accounts select',function(e){WPFormsProviders.accountSelect(this,e);});$(document).on('change','.wpforms-provider-lists select',function(e){WPFormsProviders.accountListSelect(this,e);});$(document).on('wpformsPanelSwitch',function(e,targetPanel){WPFormsProviders.providerPanelConfirm(targetPanel);});$(document).on('wpformsSaved',function(){var providerAlerts=[];var $connectionBlocks=$('#wpforms-panel-providers').find('.wpforms-connection-block');if(!$connectionBlocks.length){return;}
$connectionBlocks.each(function(){var requiredEmpty=false,providerName;$(this).find('table span.required').each(function(){var $element=$(this).parent().parent().find('select');if($element.val()===''){requiredEmpty=true;}});if(requiredEmpty){var $titleArea=$(this).closest('.wpforms-panel-content-section').find('.wpforms-panel-content-section-title').clone();$titleArea.find('button').remove();providerName=$titleArea.text().trim();var msg=wpforms_builder.provider_required_flds;if(-1<providerAlerts.indexOf(providerName)){return;}
$.alert({title:wpforms_builder.heads_up,content:msg.replace('{provider}',providerName),icon:'fa fa-exclamation-circle',type:'orange',buttons:{confirm:{text:wpforms_builder.ok,btnClass:'btn-confirm',keys:['enter'],},},});providerAlerts.push(providerName);}});});},connectionDelete:function(el,e){e.preventDefault();var $this=$(el);$.confirm({title:false,content:wpforms_builder_providers.confirm_connection,icon:'fa fa-exclamation-circle',type:'orange',buttons:{confirm:{text:wpforms_builder.ok,btnClass:'btn-confirm',keys:['enter'],action:function(){var $section=$this.closest('.wpforms-panel-content-section');$this.closest('.wpforms-provider-connection').remove();if(!$section.find('.wpforms-provider-connection').length){$section.find('.wpforms-builder-provider-connections-default').removeClass('wpforms-hidden');}},},cancel:{text:wpforms_builder.cancel,},},});},connectionAdd:function(el,e){e.preventDefault();var $this=$(el),$connections=$this.parent().parent(),$container=$this.parent(),provider=$this.data('provider'),type=$this.data('type'),namePrompt=wpforms_builder_providers.prompt_connection,nameField='<input autofocus="" type="text" id="provider-connection-name" placeholder="'+wpforms_builder_providers.prompt_placeholder+'">',nameError='<p class="error">'+wpforms_builder_providers.error_name+'</p>',modalContent=namePrompt+nameField+nameError;modalContent=modalContent.replace(/%type%/g,type);$.confirm({title:false,content:modalContent,icon:'fa fa-info-circle',type:'blue',buttons:{confirm:{text:wpforms_builder.ok,btnClass:'btn-confirm',keys:['enter'],action:function(){var name=this.$content.find('input#provider-connection-name').val().trim();var error=this.$content.find('.error');if(name===''){error.show();return false;}else{WPFormsProviders.inputToggle($this,'disable');var data={action:'wpforms_provider_ajax_'+provider,provider:provider,task:'new_connection',name:name,id:s.form.data('id'),nonce:wpforms_builder.nonce,};WPFormsProviders.fireAJAX($this,data,function(res){if(res.success){$connections.find('.wpforms-builder-provider-connections-default').addClass('wpforms-hidden');$connections.find('.wpforms-provider-connections').prepend(res.data.html);var $connection=$connections.find('.wpforms-provider-connection:first');if($connection.find('.wpforms-provider-accounts option:selected')){$connection.find('.wpforms-provider-accounts option:first').prop('selected',true);$connection.find('.wpforms-provider-accounts select').trigger('change');}}else{WPFormsProviders.errorDisplay(res.data.error,$container);}});}},},cancel:{text:wpforms_builder.cancel,},},});},accountAdd:function(el,e){e.preventDefault();var $this=$(el),provider=$this.data('provider'),$connection=$this.closest('.wpforms-provider-connection'),$container=$this.parent(),$fields=$container.find(':input'),errors=WPFormsProviders.requiredCheck($fields,$container);WPFormsProviders.inputToggle($this,'disable');if(errors){$this.prop('disabled',false).find('i').remove();return false;}
var data={action:'wpforms_provider_ajax_'+provider,provider:provider,connection_id:$connection.data('connection_id'),task:'new_account',data:WPFormsProviders.fakeSerialize($fields),};WPFormsProviders.fireAJAX($this,data,function(res){if(res.success){$container.nextAll('.wpforms-connection-block').remove();$container.nextAll('.wpforms-conditional-block').remove();$container.after(res.data.html);$container.slideUp();$connection.find('.wpforms-provider-accounts select').trigger('change');}else{WPFormsProviders.errorDisplay(res.data.error,$container);}});},accountSelect:function(el,e){e.preventDefault();var $this=$(el),$connection=$this.closest('.wpforms-provider-connection'),$container=$this.parent(),provider=$connection.data('provider');WPFormsProviders.inputToggle($this,'disable');$container.nextAll('.wpforms-connection-block').remove();$container.nextAll('.wpforms-conditional-block').remove();if(!$this.val()){$connection.find('.wpforms-provider-account-add input').val('');$connection.find('.wpforms-provider-account-add').slideDown();WPFormsProviders.inputToggle($this,'enable');}else{$connection.find('.wpforms-provider-account-add').slideUp();var data={action:'wpforms_provider_ajax_'+provider,provider:provider,connection_id:$connection.data('connection_id'),task:'select_account',account_id:$this.find(':selected').val(),};WPFormsProviders.fireAJAX($this,data,function(res){if(res.success){$container.after(res.data.html);$connection.find('.wpforms-provider-lists option:first').prop('selected',true);$connection.find('.wpforms-provider-lists select').trigger('change');}else{WPFormsProviders.errorDisplay(res.data.error,$container);}});}},accountListSelect:function(el,e){e.preventDefault();var $this=$(el),$connection=$this.closest('.wpforms-provider-connection'),$container=$this.parent(),provider=$connection.data('provider');WPFormsProviders.inputToggle($this,'disable');$container.nextAll('.wpforms-connection-block').remove();$container.nextAll('.wpforms-conditional-block').remove();var data={action:'wpforms_provider_ajax_'+provider,provider:provider,connection_id:$connection.data('connection_id'),task:'select_list',account_id:$connection.find('.wpforms-provider-accounts option:selected').val(),list_id:$this.find(':selected').val(),form_id:s.form.data('id'),};WPFormsProviders.fireAJAX($this,data,function(res){if(res.success){$container.after(res.data.html);wpf.initTooltips();}else{WPFormsProviders.errorDisplay(res.data.error,$container);}});},providerPanelConfirm:function(targetPanel){wpforms_panel_switch=true;if(targetPanel==='providers'&&!s.form.data('revision')){if(wpf.savedState!=wpf.getFormState('#wpforms-builder-form')){wpforms_panel_switch=false;$.confirm({title:false,content:wpforms_builder_providers.confirm_save,icon:'fa fa-info-circle',type:'blue',buttons:{confirm:{text:wpforms_builder.ok,btnClass:'btn-confirm',keys:['enter'],action:function(){$('#wpforms-save').trigger('click');$(document).on('wpformsSaved',function(){window.location.href=wpforms_builder_providers.url;});},},cancel:{text:wpforms_builder.cancel,},},});}}},fireAJAX:function(el,d,success){var $this=$(el);var data={id:$('#wpforms-builder-form').data('id'),nonce:wpforms_builder.nonce,};$.extend(data,d);$.post(wpforms_builder.ajax_url,data,function(res){success(res);WPFormsProviders.inputToggle($this,'enable');}).fail(function(xhr,textStatus,e){console.log(xhr.responseText);});},inputToggle:function(el,status){var $this=$(el);if(status==='enable'){if($this.is('select')){$this.prop('disabled',false).next('i').remove();}else{$this.prop('disabled',false).find('i').remove();}}else if(status==='disable'){if($this.is('select')){$this.prop('disabled',true).after(s.spinner);}else{$this.prop('disabled',true).prepend(s.spinnerWhite);}}},errorDisplay:function(msg,location){location.find('.wpforms-error-msg').remove();location.prepend('<p class="wpforms-alert-danger wpforms-alert wpforms-error-msg">'+msg+'</p>');},requiredCheck:function(fields,location){var error=false;location.find('.wpforms-alert-required').remove();fields.each(function(index,el){if($(el).hasClass('wpforms-required')&&$(el).val().length===0){$(el).addClass('wpforms-error');error=true;}else{$(el).removeClass('wpforms-error');}});if(error){location.prepend('<p class="wpforms-alert-danger wpforms-alert wpforms-alert-required">'+wpforms_builder_providers.required_field+'</p>');}
return error;},fakeSerialize:function(els){var fields=els.clone();fields.each(function(index,el){if($(el).data('name')){$(el).attr('name',$(el).data('name'));}});return fields.serialize();},};WPFormsProviders.init();})(jQuery);