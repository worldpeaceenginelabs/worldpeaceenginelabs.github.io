var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{};WPForms.Admin.Builder=WPForms.Admin.Builder||{};WPForms.Admin.Builder.Providers=WPForms.Admin.Builder.Providers||(function(document,window,$){'use strict';var __private={cache:{},config:{templates:['wpforms-providers-builder-content-connection-fields','wpforms-providers-builder-content-connection-conditionals']},fields:{},};var app={panelHolder:{},form:$('#wpforms-builder-form'),spinner:'<i class="wpforms-loading-spinner wpforms-loading-inline"></i>',ajax:{_mergeData:function(provider,custom){var data={id:app.form.data('id'),revision_id:app.form.data('revision'),nonce:wpforms_builder.nonce,action:'wpforms_builder_provider_ajax_'+provider,};$.extend(data,custom);return data;},request:function(provider,custom){var $holder=app.getProviderHolder(provider),$lock=$holder.find('.wpforms-builder-provider-connections-save-lock'),$error=$holder.find('.wpforms-builder-provider-connections-error');var params={url:wpforms_builder.ajax_url,type:'post',dataType:'json',beforeSend:function(){$holder.addClass('loading');$lock.val(1);$error.hide();},};custom.data=app.ajax._mergeData(provider,custom.data||{});$.extend(params,custom);return $.ajax(params).fail(function(jqXHR,textStatus,errorThrown){console.error('provider:',provider);console.error(jqXHR);console.error(textStatus);$lock.val(1);$error.show();}).always(function(dataOrjqXHR,textStatus,jqXHROrerrorThrown){$holder.removeClass('loading');if('success'===textStatus){$lock.val(0);}});}},cache:{get:function(provider,key){if(typeof __private.cache[provider]==='undefined'||!(__private.cache[provider]instanceof Map)){return null;}
return __private.cache[provider].get(key);},getById:function(provider,key,id){if(typeof this.get(provider,key)[id]==='undefined'){return null;}
return this.get(provider,key)[id];},set:function(provider,key,value){if(typeof __private.cache[provider]==='undefined'||!(__private.cache[provider]instanceof Map)){__private.cache[provider]=new Map();}
return __private.cache[provider].set(key,value);},addTo:function(provider,key,id,value){if(typeof __private.cache[provider]==='undefined'||!(__private.cache[provider]instanceof Map)){__private.cache[provider]=new Map();this.set(provider,key,{});}
var data=this.get(provider,key);data[id]=value;return this.set(provider,key,data);},delete:function(provider,key){if(typeof __private.cache[provider]==='undefined'||!(__private.cache[provider]instanceof Map)){return null;}
return __private.cache[provider].delete(key);},deleteFrom:function(provider,key,id){if(typeof __private.cache[provider]==='undefined'||!(__private.cache[provider]instanceof Map)){return null;}
var data=this.get(provider,key);delete data[id];return this.set(provider,key,data);},clear:function(provider){if(typeof __private.cache[provider]==='undefined'||!(__private.cache[provider]instanceof Map)){return;}
__private.cache[provider].clear();}},init:function(){$(app.ready);},ready:function(){__private.fields=$.extend({},wpf.getFields(false,true));app.panelHolder=$('#wpforms-panel-providers');app.Templates=WPForms.Admin.Builder.Templates;app.Templates.add(__private.config.templates);app.bindActions();app.ui.bindActions();app.panelHolder.trigger('WPForms.Admin.Builder.Providers.ready');},bindActions:function(){$(document).on('wpformsSaved',function(){var $connectionBlocks=$('#wpforms-panel-providers').find('.wpforms-builder-provider-connection');if(!$connectionBlocks.length){return;}
var isShownOnce=false;$connectionBlocks.each(function(){var isRequiredEmpty=false;$(this).find('input.wpforms-required, select.wpforms-required, textarea.wpforms-required').each(function(){var value=$(this).val();if(_.isEmpty(value)){$(this).addClass('wpforms-error');isRequiredEmpty=true;}else{$(this).removeClass('wpforms-error');}});if(isRequiredEmpty&&!isShownOnce){var $titleArea=$(this).closest('.wpforms-builder-provider').find('.wpforms-builder-provider-title').clone();$titleArea.find('button').remove();var msg=wpforms_builder.provider_required_flds;$.alert({title:wpforms_builder.heads_up,content:msg.replace('{provider}','<strong>'+$titleArea.text().trim()+'</strong>'),icon:'fa fa-exclamation-circle',type:'orange',buttons:{confirm:{text:wpforms_builder.ok,btnClass:'btn-confirm',keys:['enter'],},},});isShownOnce=true;}});if('fields'===wpf.getQueryString('view')){app.updateMapSelects($connectionBlocks);}});$('#wpforms-panel-providers').on('connectionRendered',function(){if(wpf.initialSave===true){wpf.savedState=wpf.getFormState('#wpforms-builder-form');}});},updateMapSelects:function($connections){var fields=$.extend({},wpf.getFields()),currentSaveFields,prevSaveFields;currentSaveFields=_.mapObject(fields,function(field,key){return field.label;});prevSaveFields=_.mapObject(__private.fields,function(field,key){return field.label;});if((_.isEmpty(currentSaveFields)&&_.isEmpty(prevSaveFields))||(JSON.stringify(currentSaveFields)===JSON.stringify(prevSaveFields))){return;}
var fieldIds=Object.keys(currentSaveFields).map(function(id){return parseInt(id,10);});var deleted=Object.keys(prevSaveFields).map(function(id){return parseInt(id,10);}).filter(function(id){return!fieldIds.includes(id);});for(var index=0;index<deleted.length;index++){$('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+deleted[index]+'"]',$connections).remove();}
var label,$exists;for(var id in fields){if(typeof fields[id].label!=='undefined'&&fields[id].label.toString().trim()!==''){label=wpf.sanitizeHTML(fields[id].label.toString().trim());}else{label=wpforms_builder.field+' #'+id;}
$exists=$('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+id+'"]',$connections);if(!$exists.length){$('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value',$connections).append($('<option>',{value:id,text:label}));continue;}
if(wpf.sanitizeHTML(fields[id].label)!==wpf.sanitizeHTML(prevSaveFields[id])){$exists.text(label);}}
if(wpf.savedState!==wpf.getFormState('#wpforms-builder-form')){wpf.savedState=wpf.getFormState('#wpforms-builder-form');}
__private.fields=fields;app.panelHolder.trigger('WPForms.Admin.Builder.Providers.updatedMapSelects',[$connections,fields]);},ui:{bindActions:function(){app.panelHolder.on('click','.js-wpforms-builder-provider-account-add',function(e){e.preventDefault();app.ui.account.setProvider($(this).data('provider'));app.ui.account.add();}).on('click','.js-wpforms-builder-provider-connection-add',function(e){e.preventDefault();app.ui.connectionAdd($(this).data('provider'));}).on('click','.js-wpforms-builder-provider-connection-delete',function(e){var $btn=$(this);e.preventDefault();app.ui.connectionDelete($btn.closest('.wpforms-builder-provider').data('provider'),$btn.closest('.wpforms-builder-provider-connection'));});app.panelHolder.on('click','.js-wpforms-builder-provider-connection-fields-add',function(e){e.preventDefault();var $table=$(this).parents('.wpforms-builder-provider-connection-fields-table'),$clone=$table.find('tr').last().clone(true),nextID=parseInt(/\[.+]\[.+]\[.+]\[(\d+)]/.exec($clone.find('.wpforms-builder-provider-connection-field-name').attr('name'))[1],10)+1;$clone.find('.wpforms-builder-provider-connection-field-name').attr('name',$clone.find('.wpforms-builder-provider-connection-field-name').attr('name').replace(/\[fields_meta\]\[(\d+)\]/g,'[fields_meta]['+nextID+']')).val('');$clone.find('.wpforms-builder-provider-connection-field-value').attr('name',$clone.find('.wpforms-builder-provider-connection-field-value').attr('name').replace(/\[fields_meta\]\[(\d+)\]/g,'[fields_meta]['+nextID+']')).val('');$clone.find('.js-wpforms-builder-provider-connection-fields-delete').removeClass('hidden');$table.find('tbody').append($clone.get(0));}).on('click','.js-wpforms-builder-provider-connection-fields-delete',function(e){e.preventDefault();var $row=$(this).parents('.wpforms-builder-provider-connection-fields-table tr');$row.remove();});$('#wpforms-panel-providers').on('connectionGenerated',function(e,data){wpf.initTooltips();$(this).find('.wpforms-builder-provider-connection[data-connection_id="'+data.connection.id+'"]').closest('.wpforms-panel-content-section').find('.wpforms-builder-provider-connections-default').addClass('wpforms-hidden');});$('#wpforms-panel-providers').on('connectionRendered',function(e,provider,connectionId){wpf.initTooltips();if(typeof connectionId==='undefined'){if(!_.isObject(provider)||!_.has(provider,'connection_id')){return;}
connectionId=provider.connection_id;}
if($(this).find('.wpforms-builder-provider-connection[data-connection_id="'+connectionId+'"] .wpforms-field-map-select').length){wpf.fieldUpdate();}});},connectionAdd:function(provider){$.confirm({title:false,content:wpforms_builder_providers.prompt_connection.replace(/%type%/g,'connection')+
'<input autofocus="" type="text" id="wpforms-builder-provider-connection-name" placeholder="'+wpforms_builder_providers.prompt_placeholder+'">'+
'<p class="error">'+wpforms_builder_providers.error_name+'</p>',icon:'fa fa-info-circle',type:'blue',buttons:{confirm:{text:wpforms_builder.ok,btnClass:'btn-confirm',keys:['enter'],action:function(){var name=this.$content.find('#wpforms-builder-provider-connection-name').val().trim(),error=this.$content.find('.error');if(name===''){error.show();return false;}else{app.getProviderHolder(provider).trigger('connectionCreate',[name]);}},},cancel:{text:wpforms_builder.cancel,},},});},connectionDelete:function(provider,$connection){$.confirm({title:false,content:wpforms_builder_providers.confirm_connection,icon:'fa fa-exclamation-circle',type:'orange',buttons:{confirm:{text:wpforms_builder.ok,btnClass:'btn-confirm',keys:['enter'],action:function(){app.getProviderHolder(provider).trigger('connectionDelete',[$connection]);var $section=$connection.closest('.wpforms-panel-content-section');$connection.fadeOut('fast',function(){$(this).remove();app.getProviderHolder(provider).trigger('connectionDeleted',[$connection]);if(!$section.find('.wpforms-builder-provider-connection').length){$section.find('.wpforms-builder-provider-connections-default').removeClass('wpforms-hidden');}});},},cancel:{text:wpforms_builder.cancel,},},});},account:{provider:'',submitHandlers:[],setProvider:function(provider){this.provider=provider;},add:function(){var account=this;$.confirm({title:false,smoothContent:true,content:function(){var modal=this;return app.ajax.request(account.provider,{data:{task:'account_template_get',},}).done(function(response){if(!response.success){return;}
if(response.data.title.length){modal.setTitle(response.data.title);}
if(response.data.content.length){modal.setContent(response.data.content);}
if(response.data.type.length){modal.setType(response.data.type);}
app.getProviderHolder(account.provider).trigger('accountAddModal.content.done',[modal,account.provider,response]);}).fail(function(){app.getProviderHolder(account.provider).trigger('accountAddModal.content.fail',[modal,account.provider]);}).always(function(){app.getProviderHolder(account.provider).trigger('accountAddModal.content.always',[modal,account.provider]);});},contentLoaded:function(data,status,xhr){var modal=this;this.buttons.add.enable();this.buttons.cancel.enable();app.getProviderHolder(account.provider).trigger('accountAddModal.contentLoaded',[modal]);},onOpenBefore:function(){var modal=this;modal.buttons.add.disable();modal.buttons.cancel.disable();modal.$body.addClass('wpforms-providers-account-add-modal');app.getProviderHolder(account.provider).trigger('accountAddModal.onOpenBefore',[modal]);},onClose:function(){if(true===app.ui.account.isConfigured(account.provider)){app.ui.connectionAdd(account.provider);}},icon:'fa fa-info-circle',type:'blue',buttons:{add:{text:wpforms_builder.provider_add_new_acc_btn,btnClass:'btn-confirm',keys:['enter'],action:function(){var modal=this;app.getProviderHolder(account.provider).trigger('accountAddModal.buttons.add.action.before',[modal]);if(!_.isEmpty(account.provider)&&typeof account.submitHandlers[account.provider]!=='undefined'){return account.submitHandlers[account.provider](modal);}},},cancel:{text:wpforms_builder.cancel,},},});},registerAddHandler:function(provider,handler){if(typeof provider==='string'&&typeof handler==='function'){this.submitHandlers[provider]=handler;}},isConfigured:function(provider){return app.getProviderHolder(provider).find('.js-wpforms-builder-provider-account-add').hasClass('hidden');},},},getProviderHolder:function(provider){return $('#'+provider+'-provider');},};return app;}(document,window,jQuery));WPForms.Admin.Builder.Providers.init();